<!doctype html>
<html>

<head>
  <meta name="viewport" content="width=400, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <title>(t,i,x,y) => "creative code golfing"</title>
  <meta name="description"
    content="A minimalist coding environment. Control 16x16 points with a single JavaScript function.">

  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@aemkei" />
  <meta name="twitter:title" content="(t,i,x,y) => 'creative code golfing'" />
  <meta name="twitter:description"
    content="A minimalist coding environment. Control 16x16 points with a single JavaScript function. By @aemkei" />
  <meta name="twitter:image" content="https://tixy.land/twitter-card.png" />
  <style>
    html {
      background-color: #000;
      color: #fff;
      height: 100%
    }

    * {
      box-sizing: border-box
    }

    a:link,
    a:visited {
      color: #f24
    }

    *,
    html,
    input {
      font-family: monospace;
      font-size: 14px
    }

    body {
      padding: 0;
      margin: 0;
      display: grid;
      align-items: center;
      justify-items: center;
      height: 100%
    }

    #editor,
    #output,
    input,
    label {
      display: block
    }

    #editor {
      width: 272px;
      line-height: 1.15em
    }

    #comment {
      color: #f24
    }

    #input {
      background: 0 0;
      color: #fff;
      padding: 0;
      margin: .15em 0;
      border: 0;
      width: 100%
    }

    #input:focus {
      outline: 0
    }

    #code-runner {
      display: none
    }
  </style>
</head>

<body>
  <canvas id="output"></canvas>

  <form id="editor">
    <div id="comment">
      <label for="input">// tixy - creative code golfing</label>
      <label for="input">// click the dots for more</label>
    </div>

    <label id="label" for="input">(t,i,x,y) =></label>
    <input name="code" id="input" type="text" value="Math.sin(y/8 + t)" autocomplete="off" autocapitalize="off"
      spellcheck="false" autocorrect="off" maxlength="32" />
    </div>

    <iframe id="code-runner" sandbox="allow-same-origin"></iframe>
    <script type="module">
      import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r113/build/three.module.js';
      import * as oc from 'https://threejsfundamentals.org/threejs/resources/threejs/r113/examples/jsm/controls/OrbitControls.js';

      function sphere(color) {
        let geometry = new THREE.SphereGeometry(0.48, 32, 32);
        //let material = new THREE.MeshBasicMaterial({ color });
        let material = new THREE.MeshPhongMaterial({ color: 0x156289, emissive: 0x072534, flatShading: true });
        let shape = new THREE.Mesh(geometry, material);
        // shape.position.x = wp.x;
        // shape.position.y = wp.y;
        // shape.position.z = wp.z;
        return shape;
      }

      const count = 16;
      const size = 16;
      const spacing = 1;
      const width = count * (size + spacing);

      const output = document.getElementById('output');
      output.width = output.height = width;

      const scene = new THREE.Scene();
      const color = 0xFFFFFF;
      const intensity = 1;
      const light = new THREE.DirectionalLight(color, intensity);
      light.position.set(-1, 10, 4);
      scene.add(light);
      const ambient_light = new THREE.AmbientLight(0x404040); // soft white light
      scene.add(ambient_light);

      let canvas = document.querySelector("#output");
      let renderer = new THREE.WebGLRenderer({ canvas });

      window.scene = scene;
      window.canvas = canvas;
      window.renderer = renderer;

      let camera = new THREE.PerspectiveCamera(
        50,
        1.0,
        1.0,
        1000,
      );
      camera.position.set(0, 0, 20.0);
      let controls = new oc.OrbitControls(camera, canvas);

      // import examples from './examples.json';
      window.examples = {
        "return the visibility\nfor every dot (true|false)": "Math.random() < 0.1",
        "the radius can also be \nbetween 0 and 1": "Math.random()",
        "parameter `t` is \nthe time in seconds": "Math.sin(t)",
        "param `i` is the index \nof the dot (0..255)": "i / 256",
        "`x` is the column index\n from 1 to 16": "x / 16",
        "`y` is the row\n also from 1 to 16": "y / 16",
        "positive numbers are white,\nnegatives are red": "y - 8.5",
        "use the time\nto animate values": "y - t",
        "multiply the time\nto change the speed": "y - t*4",
        "create patterns using \ndifferent color": "[1, 0, -1][i%3]",
        "more examples ...": "Math.sin(y/8 + t)",
        "simple triangle": "y - x",
        "quarter triangle": "(y > x) && (16-x < y)",
        "pattern": "i%4 - y%4",
        "grid": "x%4 && y%4",
        "square": "x>4 & y>4 & x<12 & y<12",
        "animated square": "-(x>t & y>t & x<16-t & y<16-t)",
        "mondrian squares": "(y-6) * (x-6)",
        "moving cross": "(y-4*t|0) * (x-8-t|0)",
        "sierpinski": "4 * t & i & x & y",
        "binary clock": "(t*10) & (1<<x) && y==8",
        "random noise": "Math.random() * 2 - 1",
        "smooth noise": "Math.sin(i ** 2)",
        "animated smooth noise": "Math.cos(t + i*x*y)",
        "waves": "Math.sin(x/2)-Math.sin(x-t)-y+6",
        "ripples\bby @thespite": "Math.sin(t-Math.sqrt(x*x+y*y))",
        "diagonals": "y == x || -(17-x == y)",
        "wipe": "(x-y) - Math.sin(t) * 16",
        "soft wipe": "(x-y)/24 - Math.sin(t)",
        "disco": "Math.sin(t*5) * Math.tan(t*7)",
        "input is limited \nto 32 characters!": "(x-5)**2+(y-5)**2-99*Math.sin(t)",
        "click here to \ncreate your own": "'HAVE FUN!'"
      }

      const runner = document.getElementById('code-runner').contentWindow;
      const input = document.getElementById('input');
      const editor = document.getElementById('editor');
      const comment = document.getElementById('comment');
      const context = output.getContext('2d');

      let callback = function () { };
      let startTime = new Date();
      let code = '';

      const cells = [];

      for (let y = 0, index = 0; y < count; y++) {
        for (let x = 0; x < count; x++) {
          index++;

          // cells.push({
          //   index,
          //   x,
          //   y
          // });
          let shape = sphere(0xffffff);
          scene.add(shape);
          cells.push(shape);
        }
      }
      window.cells = cells;

      function readURL() {
        const url = new URL(document.location);

        if (url.searchParams.has('code')) {
          input.value = url.searchParams.get('code');
        }
      }

      readURL();

      function updateCallback() {
        code = input.value;
        startTime = new Date();

        try {
          callback = runner.eval(`
      (function f(t,i,x,y) {
        try {
          let sin = Math.sin
          let cos = Math.cos
          let tan = Math.tan
          let abs = Math.abs
          let ran = Math.random
          return ${code.replace(/\\/g, ';')};
        } catch (error) {
          return error;
        }
      })
    `);
        } catch (error) {
          callback = null;
        }
      }

      updateCallback();
      input.addEventListener('input', updateCallback);

      input.addEventListener('focus', function () {
        updateComments(['hit "enter" to save in URL', 'or get <a href="https://twitter.com/aemkei/status/1323399877611708416" target="_blank">more info here</a>']);
      });

      input.addEventListener('blur', updateCommentsForCode);

      editor.addEventListener('submit', (event) => {
        event.preventDefault();
        const url = new URL(document.location);
        url.searchParams.set('code', code);
        history.replaceState(null, code, url);
      });

      function render() {
        // scene.remove(...scene.children);
        const time = (new Date() - startTime) / 1000;

        if (!callback) {
          window.requestAnimationFrame(render);
          return;
        }

        output.width = output.height = width;
        let index = 0;
        for (let y = 1; y <= count; y++) {
          for (let x = 1; x <= count; x++) {
            index++;

            const value = callback(time, index, x, y);
            const offset = size / 2;
            let color = '#FFF';
            let radius = (value * size) / 2;

            if (radius < 0) {
              radius = -radius;
              color = '#F24';
            }

            if (radius > size / 2) {
              radius = size / 2;
            }

            let scale = radius / (size / 2);
            let shape = cells[index - 1];
            shape.position.x = x - 8.5;
            shape.position.y = y - 8.5;
            shape.material.color = new THREE.Color(color);
            shape.scale.x = scale + 0.00001;
            shape.scale.y = scale + 0.00001;
            shape.scale.z = scale + 0.00001;

            //   context.beginPath();
            //   context.fillStyle = color;
            //   context.arc(
            //     x * (size + spacing) - offset,
            //     y * (size + spacing) - offset,
            //     radius,
            //     0,
            //     2 * Math.PI
            //   );
            //   context.fill();
          }
        }

        controls.update();
        renderer.render(scene, camera);

        window.requestAnimationFrame(render);
      }

      render();

      function updateComments(comments) {
        const lines = comment.querySelectorAll('label');

        if (comments.length === 1) {
          lines[0].innerHTML = '&nbsp;';
          lines[1].innerHTML = `// ${comments[0]}`;
        } else {
          lines[0].innerHTML = `// ${comments[0]}`;
          lines[1].innerHTML = `// ${comments[1]}`;
        }
      }

      function updateCommentsForCode() {

        const code = input.value;

        const snippets = Object.values(examples);
        const comments = Object.keys(examples);
        const index = snippets.indexOf(code);
        const newComments = comments[index].split('\n');

        updateComments(newComments);
      }

      function nextExample() {
        const snippets = Object.values(examples);

        let index = snippets.indexOf(code);

        if (snippets[index + 1]) {
          index = index + 1;
        } else {
          return;
        }

        const newCode = snippets[index];
        input.value = newCode;

        updateCommentsForCode();

        // history.replaceState({
        //   code: newCode,
        //   comment: newComment
        // }, code, `?code=${encodeURIComponent(newCode)}`);

        updateCallback();
      }

      output.addEventListener('click', nextExample);

      window.onpopstate = function (event) {
        readURL();
        updateCallback();
      };


      updateCommentsForCode();

    </script>
</body>

</html>